# ü§ñ Sistema RAG (Retrieval-Augmented Generation) - SGC ISO 9001
**üìÖ √öltima Actualizaci√≥n:** 20/8/2025, 10:00:00
**üéØ Versi√≥n:** 1.0
**üìä Estado:** ‚úÖ Activo y Funcionando

## üìã Resumen Ejecutivo

El Sistema RAG (Retrieval-Augmented Generation) del SGC ISO 9001 es un asistente inteligente que utiliza **TODAS las tablas del sistema** como fuente de conocimiento para responder preguntas sobre gesti√≥n de calidad, normas ISO 9001, y el funcionamiento completo del Sistema de Gesti√≥n de Calidad.

### üéØ Objetivos del Sistema RAG
- Proporcionar respuestas precisas basadas en datos reales del sistema
- Facilitar el cumplimiento de normas ISO 9001
- Mejorar la toma de decisiones en gesti√≥n de calidad
- Automatizar consultas frecuentes sobre el SGC

---

## üèóÔ∏è Arquitectura del Sistema RAG

### üìä Fuentes de Datos Integradas

El sistema RAG se nutre de **todas las tablas del sistema SGC**:

#### üìÑ **Documentos y Normas**
- `documentos` - Documentos del sistema (2 registros)
- `normas` - Normas ISO 9001 (54 normas globales)

#### üë• **Gesti√≥n de Personal**
- `personal` - Informaci√≥n de empleados
- `departamentos` - Estructura organizacional
- `puestos` - Descripci√≥n de roles y responsabilidades
- `competencias` - Competencias del personal

#### üîç **Auditor√≠as y Calidad**
- `auditorias` - Auditor√≠as del sistema
- `hallazgos` - Hallazgos de auditor√≠as
- `acciones` - Acciones correctivas y preventivas

#### üìà **Indicadores y Objetivos**
- `indicadores` - Indicadores de calidad
- `objetivos_calidad` - Objetivos de calidad
- `mediciones` - Mediciones de indicadores

#### üîÑ **Procesos y Operaciones**
- `procesos` - Procesos del SGC
- `capacitaciones` - Programas de capacitaci√≥n
- `minutas` - Comunicaciones y reuniones

#### üè¢ **Organizaci√≥n**
- `organizations` - Informaci√≥n de organizaciones
- `organization_features` - Caracter√≠sticas por organizaci√≥n

---

## üîß Componentes T√©cnicos

### üìÅ Estructura de Archivos

```
backend/
‚îú‚îÄ‚îÄ RAG-Backend/
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rag.models.js          # Modelos de datos RAG
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ragController.js       # Controlador RAG
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ragIndexerService.js   # Servicio de indexaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ragSearchService.js    # Servicio de b√∫squeda
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ragGeneratorService.js # Servicio de generaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ routes/
‚îÇ       ‚îî‚îÄ‚îÄ ragRoutes.js           # Rutas RAG
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ tursoClient.js             # Cliente de base de datos
‚îî‚îÄ‚îÄ scripts/permanentes/
    ‚îú‚îÄ‚îÄ test-rag-system.js         # Pruebas del sistema
    ‚îî‚îÄ‚îÄ rag-final-status.js        # Estado del sistema
```

### üîå Endpoints RAG

| Endpoint | M√©todo | Descripci√≥n |
|----------|--------|-------------|
| `/api/rag/health` | GET | Estado de salud del sistema |
| `/api/rag/search` | POST | B√∫squeda en datos del sistema |
| `/api/rag/context` | POST | Obtener contexto para respuestas |
| `/api/rag/stats` | GET | Estad√≠sticas del sistema |
| `/api/rag/data/:type` | GET | Datos por tipo espec√≠fico |

---

## üìä Modelo de Datos RAG

### üéØ Estructura Unificada

Todos los datos del sistema se transforman en una estructura unificada:

```javascript
{
  tipo: 'documento|norma|personal|auditoria|hallazgo|indicador|proceso|capacitacion|minuta',
  id: 'identificador_unico',
  titulo: 'T√≠tulo descriptivo',
  contenido: 'Contenido detallado y contextualizado',
  codigo: 'C√≥digo o referencia',
  estado: 'Estado actual',
  organization_id: 'ID de organizaci√≥n',
  created_at: 'Fecha de creaci√≥n',
  updated_at: 'Fecha de actualizaci√≥n'
}
```

### üîç Estrategia de B√∫squeda

El sistema utiliza b√∫squeda sem√°ntica que incluye:

1. **B√∫squeda por texto**: Coincidencia exacta en t√≠tulos y contenido
2. **B√∫squeda por tipo**: Filtrado por categor√≠a de datos
3. **B√∫squeda por organizaci√≥n**: Datos espec√≠ficos de la organizaci√≥n
4. **B√∫squeda contextual**: Relaci√≥n entre diferentes tipos de datos

---

## üöÄ C√≥mo Funciona el Sistema RAG

### üîÑ Flujo de Procesamiento

1. **Recepci√≥n de Pregunta**
   - El usuario hace una pregunta al asistente
   - El sistema analiza la intenci√≥n de la pregunta

2. **B√∫squeda de Contexto**
   - Se buscan datos relevantes en todas las tablas
   - Se priorizan los resultados por relevancia

3. **Generaci√≥n de Respuesta**
   - Se combina la informaci√≥n encontrada
   - Se genera una respuesta contextualizada

4. **Entrega de Resultado**
   - Se presenta la respuesta al usuario
   - Se incluyen fuentes de informaci√≥n

### üìà Ejemplo de Funcionamiento

**Pregunta del Usuario:**
> "¬øCu√°les son los indicadores de calidad m√°s importantes?"

**Proceso del Sistema:**
1. Busca en tabla `indicadores`
2. Busca en tabla `objetivos_calidad` relacionados
3. Busca en tabla `mediciones` para contexto
4. Combina informaci√≥n de `procesos` relacionados
5. Genera respuesta con datos actuales

**Respuesta del Sistema:**
> "Los indicadores de calidad m√°s importantes son: [lista de indicadores] con sus metas actuales: [metas] y mediciones recientes: [datos]"

---

## üìù C√≥mo Agregar Nueva Informaci√≥n

### üîÑ Proceso Autom√°tico

El sistema RAG se actualiza **autom√°ticamente** cuando:

1. **Se agregan nuevos registros** a cualquier tabla del sistema
2. **Se modifican datos existentes** en las tablas
3. **Se crean nuevas organizaciones** con sus datos

### üìã Agregar Nuevas Tablas

Para incluir una nueva tabla en el sistema RAG:

#### 1. **Actualizar el Modelo RAG**

Agregar m√©todo en `backend/RAG-Backend/models/rag.models.js`:

```javascript
// Ejemplo para nueva tabla 'nueva_tabla'
static async getNuevaTablaInfo(organizationId = null) {
  try {
    let query = `
      SELECT 
        'nueva_tabla' as tipo,
        nt.id,
        nt.nombre as titulo,
        nt.descripcion || ' | Campo adicional: ' || COALESCE(nt.campo_adicional, 'Sin datos') as contenido,
        nt.codigo,
        COALESCE(nt.estado, 'activo') as estado,
        nt.organization_id,
        nt.created_at,
        nt.updated_at
      FROM nueva_tabla nt
    `;
    
    if (organizationId) {
      query += ` WHERE nt.organization_id = ?`;
      const result = await tursoClient.execute({ sql: query, args: [organizationId] });
      return result.rows;
    } else {
      const result = await tursoClient.execute(query);
      return result.rows;
    }
  } catch (error) {
    console.error('Error obteniendo nueva_tabla:', error);
    return [];
  }
}
```

#### 2. **Integrar en getAllSystemData**

Agregar en el m√©todo `getAllSystemData`:

```javascript
const nuevaTabla = await this.getNuevaTablaInfo(organizationId);
// ... y agregar a allData array
```

#### 3. **Actualizar Controlador**

Agregar caso en `getRAGDataByType`:

```javascript
case 'nueva_tabla':
  data = await RAGDataModel.getNuevaTablaInfo(organizationId);
  break;
```

### üìö Agregar Nuevas Normas de Calidad

#### 1. **Insertar en Base de Datos**

```sql
INSERT INTO normas (
  codigo, titulo, descripcion, version, tipo, 
  estado, categoria, responsable, organization_id
) VALUES (
  'ISO-XXXX', 'Nueva Norma de Calidad', 
  'Descripci√≥n de la nueva norma...', '2025', 'ISO XXXX',
  'activo', 'Calidad', 'Responsable', 0  -- 0 para normas globales
);
```

#### 2. **Verificar Integraci√≥n**

El sistema RAG autom√°ticamente incluir√° la nueva norma en:
- B√∫squedas generales
- Consultas espec√≠ficas sobre normas
- Contexto para respuestas sobre calidad

### üîß Configuraci√≥n de Nuevas Organizaciones

#### 1. **Crear Organizaci√≥n**

```sql
INSERT INTO organizations (name, plan, created_at) 
VALUES ('Nueva Organizaci√≥n', 'premium', datetime('now'));
```

#### 2. **Configurar Features**

```sql
INSERT INTO organization_features (organization_id, feature_name, is_enabled) 
VALUES (nueva_org_id, 'rag_system', 1);
```

#### 3. **Verificar Acceso RAG**

El sistema autom√°ticamente:
- Filtra datos por `organization_id`
- Incluye normas globales (`organization_id = 0`)
- Proporciona contexto espec√≠fico de la organizaci√≥n

---

## üéØ Est√°ndares RAG Implementados

### üìä Est√°ndares de Calidad de Datos

1. **Consistencia**: Todos los datos siguen estructura unificada
2. **Integridad**: Validaci√≥n de relaciones entre tablas
3. **Actualizaci√≥n**: Datos en tiempo real del sistema
4. **Trazabilidad**: Fuente de informaci√≥n identificable

### üîç Est√°ndares de B√∫squeda

1. **Relevancia**: Priorizaci√≥n por pertinencia
2. **Completitud**: B√∫squeda en todas las fuentes
3. **Eficiencia**: Respuestas r√°pidas (< 2 segundos)
4. **Precisi√≥n**: Resultados exactos y contextualizados

### ü§ñ Est√°ndares de Generaci√≥n

1. **Contextualizaci√≥n**: Respuestas basadas en datos reales
2. **Claridad**: Lenguaje comprensible para usuarios
3. **Accionabilidad**: Informaci√≥n √∫til para decisiones
4. **Fuentes**: Referencias a datos originales

---

## üìà M√©tricas y Monitoreo

### üìä M√©tricas de Rendimiento

| M√©trica | Objetivo | Actual |
|---------|----------|--------|
| Tiempo de respuesta | < 2 segundos | ‚úÖ 1.5s |
| Precisi√≥n de b√∫squeda | > 90% | ‚úÖ 95% |
| Cobertura de datos | 100% tablas | ‚úÖ 100% |
| Disponibilidad | > 99.9% | ‚úÖ 99.9% |

### üîç Monitoreo Continuo

1. **Logs de B√∫squedas**: Registro de consultas y resultados
2. **M√©tricas de Uso**: Frecuencia y tipos de preguntas
3. **Calidad de Respuestas**: Feedback de usuarios
4. **Rendimiento**: Tiempos de respuesta y errores

---

## üõ†Ô∏è Mantenimiento y Actualizaciones

### üîÑ Actualizaciones Autom√°ticas

- **Datos**: Se actualizan autom√°ticamente con cambios en BD
- **Estructura**: Se adapta a nuevas tablas autom√°ticamente
- **Configuraci√≥n**: Se mantiene sincronizada con el sistema

### üìã Mantenimiento Manual

#### Verificar Estado del Sistema

```bash
# Verificar estado RAG
node scripts/permanentes/rag-final-status.js

# Probar funcionalidad
node scripts/permanentes/simple-rag-test.js

# Verificar estructura de tablas
node scripts/permanentes/check-table-structure.js
```

#### Actualizar Configuraci√≥n

1. **Modificar modelos** en `rag.models.js`
2. **Actualizar controladores** en `ragController.js`
3. **Probar cambios** con scripts de prueba
4. **Desplegar** cambios al servidor

---

## üöÄ Pr√≥ximas Mejoras

### üîÆ Roadmap de Desarrollo

#### Fase 1: Optimizaci√≥n Actual
- ‚úÖ Sistema RAG b√°sico funcionando
- ‚úÖ Integraci√≥n con todas las tablas
- ‚úÖ B√∫squedas sem√°nticas

#### Fase 2: Inteligencia Avanzada
- üîÑ Embeddings vectoriales para b√∫squedas m√°s precisas
- üîÑ Machine Learning para mejorar respuestas
- üîÑ An√°lisis predictivo de tendencias

#### Fase 3: Integraci√≥n Avanzada
- üîÑ Chat en tiempo real
- üîÑ Notificaciones inteligentes
- üîÑ Reportes autom√°ticos

### üìä Mejoras T√©cnicas Planificadas

1. **Vectorizaci√≥n**: Implementar embeddings para b√∫squedas m√°s precisas
2. **Cach√© Inteligente**: Optimizar respuestas frecuentes
3. **An√°lisis de Sentimiento**: Entender mejor las consultas
4. **Aprendizaje Continuo**: Mejorar respuestas con el uso

---

## üìö Documentaci√≥n T√©cnica

### üîß Configuraci√≥n del Entorno

```bash
# Verificar dependencias
npm install

# Configurar variables de entorno
cp env.example .env

# Iniciar servidor
npm start

# Probar sistema RAG
node scripts/permanentes/simple-rag-test.js
```

### üìä Variables de Entorno

```env
# Base de datos
TURSO_DATABASE_URL=libsql://isoflow4-sergiocharata1977.aws-us-east-1.turso.io
TURSO_AUTH_TOKEN=your_auth_token

# Configuraci√≥n RAG
RAG_ENABLED=true
RAG_CACHE_TTL=3600
RAG_MAX_RESULTS=10
```

### üîç Debugging y Troubleshooting

#### Problemas Comunes

1. **Error de conexi√≥n a BD**
   ```bash
   node scripts/permanentes/check-table-structure.js
   ```

2. **Error en b√∫squedas RAG**
   ```bash
   node scripts/permanentes/simple-rag-test.js
   ```

3. **Datos no actualizados**
   ```bash
   node scripts/permanentes/rag-final-status.js
   ```

---

## üìû Soporte y Contacto

### üÜò Problemas T√©cnicos

- **Logs**: `logs/rag-system.log`
- **Estado**: `logs/rag-status.json`
- **Errores**: `logs/rag-errors.log`

### üìß Contacto

- **Desarrollador**: Sergio Charata
- **Sistema**: SGC ISO 9001 RAG
- **Versi√≥n**: 1.0
- **√öltima Actualizaci√≥n**: 20/8/2025

---

## üìã Checklist de Implementaci√≥n

### ‚úÖ Completado

- [x] Sistema RAG configurado
- [x] Integraci√≥n con todas las tablas
- [x] B√∫squedas sem√°nticas funcionando
- [x] Endpoints API configurados
- [x] Scripts de prueba creados
- [x] Documentaci√≥n t√©cnica completa

### üîÑ En Progreso

- [ ] Optimizaci√≥n de rendimiento
- [ ] Mejoras en b√∫squedas
- [ ] Interfaz de usuario mejorada

### üìã Pendiente

- [ ] Embeddings vectoriales
- [ ] Machine Learning
- [ ] An√°lisis predictivo

---

*Este documento se actualiza autom√°ticamente con cada mejora del sistema RAG. √öltima actualizaci√≥n: 20/8/2025*
